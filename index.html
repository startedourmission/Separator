<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>토인비분판</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">

        <div class="controls" id="left-panel">
            <button class="toggle-sidebar" id="toggle-left" title="왼쪽 패널 접기/펴기">◀</button>
            <div class="file-section">
                <label for="pdf-file">PDF 파일 선택:</label>
                <input type="file" id="pdf-file" accept=".pdf">
            </div>

            <div class="viewer-controls">
                <h3>페이지 정보</h3>
                <div class="info-row">
                    <span class="info-label">전체 크기 (MediaBox):</span>
                    <span id="mediabox-dim" class="info-value">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">재단 크기 (TrimBox):</span>
                    <span id="trimbox-dim" class="info-value">-</span>
                </div>
            </div>

            <div class="viewer-controls">
                <h3>표지 펼침면 계산</h3>
                <div class="input-row" style="display: flex; gap: 10px; margin-bottom: 5px;">
                    <div style="flex: 1;">
                        <label for="spine-width">책등 (mm):</label>
                        <input type="number" id="spine-width" value="17" min="0" step="0.5" style="width: 100%;">
                    </div>
                    <div style="flex: 1;">
                        <label for="flap-width">날개 (mm):</label>
                        <input type="number" id="flap-width" value="90" min="0" step="0.5" style="width: 100%;">
                    </div>
                </div>
                <div class="input-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <label for="cover-width">표지 (mm):</label>
                        <input type="number" id="cover-width" value="188" min="0" step="0.5" style="width: 100%;">
                    </div>
                    <div style="flex: 1;">
                        <label for="flap-margin-width">날개여백 (mm):</label>
                        <input type="number" id="flap-margin-width" value="5" min="0" step="0.5" style="width: 100%;">
                    </div>
                </div>
                <!-- 결과 표시 (단순 텍스트) -->
                <div id="calc-result"
                    style="margin-top: 10px; font-weight: bold; color: #3498db; text-align: right; border-top: 1px solid #eee; padding-top: 10px;">
                    <!-- JS에서 업데이트함 -->
                </div>
                <button id="auto-detect-crop" class="tool-btn"
                    style="width: 100%; margin-top: 15px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    <span class="icon">📏</span> 재단선 인식 자동 계산
                </button>
            </div>

            <div class="separation-controls">
                <h3>CMYK 분판 제어</h3>
                <div class="cmyk-controls">
                    <div class="control-row">
                        <input type="checkbox" id="select-all" checked>
                        <label for="select-all" class="select-all-label">전체 선택</label>
                    </div>
                    <div class="control-row">
                        <input type="checkbox" id="cyan" checked>
                        <label for="cyan" class="color-label cyan">C (Cyan)</label>
                        <span class="channel-ratio" id="cyan-ratio">-</span>
                    </div>
                    <div class="control-row">
                        <input type="checkbox" id="magenta" checked>
                        <label for="magenta" class="color-label magenta">M (Magenta)</label>
                        <span class="channel-ratio" id="magenta-ratio">-</span>
                    </div>
                    <div class="control-row">
                        <input type="checkbox" id="yellow" checked>
                        <label for="yellow" class="color-label yellow">Y (Yellow)</label>
                        <span class="channel-ratio" id="yellow-ratio">-</span>
                    </div>
                    <div class="control-row">
                        <input type="checkbox" id="black" checked>
                        <label for="black" class="color-label black">K (Black)</label>
                        <span class="channel-ratio" id="black-ratio">-</span>
                    </div>
                </div>

                <!-- 별색 분판 제어 (Task 2.4) -->
                <br>
                <h3>별색 감지</h3>
                <div id="spot-color-controls" class="spot-controls" style="display: none;">
                    <!-- 동적으로 생성됨 -->
                </div>

                <!-- 스캔 진행률 표시 -->
                <div class="scan-progress-section hidden" id="scan-progress-section">
                    <h4>CMYK 데이터 수집</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="scan-progress-fill"></div>
                    </div>
                    <div class="progress-text" id="scan-progress-text">0/0 페이지 (0%)</div>
                </div>
            </div>

            <div class="info-panel">
                <h3>정보</h3>
                <div class="ink-info">
                    <span>마우스 위치 잉크량 (TAC): </span>
                    <span id="tac-value">-</span>%
                </div>
                <div class="cursor-position">
                    <span>좌표: </span>
                    <span id="cursor-coords">-</span>
                </div>
                <!-- Task 5.2: 별색 잉크량 표시 영역 -->
                <div id="spot-ink-info" class="spot-ink-info">
                    <!-- 동적으로 생성됨 -->
                </div>
            </div>
            <!-- Watermark controls moved to right panel -->

            <div class="viewer-controls">
                <h3>뷰어 제어</h3>
                <div class="view-mode-controls">
                    <label for="view-mode">보기 모드:</label>
                    <select id="view-mode">
                        <option value="single">한 페이지</option>
                        <option value="two-page">두 페이지</option>
                    </select>
                </div>
                <div class="zoom-controls">
                    <label for="zoom-slider">확대/축소:</label>
                    <input type="range" id="zoom-slider" min="25" max="500" value="100" step="25">
                    <span id="zoom-value">100%</span>
                </div>
                <div class="quality-controls"
                    style="margin-bottom: 10px; padding: 7px; background: #f8f9fa; border-radius: 4px;">
                    <label for="quality-select" style="display: block; margin-bottom: 8px; font-weight: 600;">렌더링 화질
                        (DPI):</label>
                    <select id="quality-select"
                        style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="150">150 DPI (저화질)</option>
                        <option value="300" selected>300 DPI (고화질 - 기본)</option>
                        <option value="450">450 DPI (초고화질)</option>
                        <option value="600">600 DPI (인쇄용)</option>
                        <option value="1200">1200 DPI (최대)</option>
                    </select>
                </div>
                <div class="page-controls">
                    <button id="prev-page" disabled>◀ 이전</button>
                    <span id="page-info">페이지 <input type="number" id="current-page" value="1" min="1"> / <span
                            id="total-pages">1</span></span>
                    <button id="next-page" disabled>다음 ▶</button>
                </div>
            </div>
        </div>

        <div class="scroll-viewport" id="scroll-viewport">
            <div class="scroll-content" id="scroll-content">
                <!-- 동적으로 페이지 wrapper들이 추가됨 -->
            </div>
            <!-- 로딩 인디케이터 -->
            <div id="loading-indicator" class="loading-overlay hidden">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <div id="loading-text">로딩 중...</div>
                    <div id="loading-progress" class="loading-progress"></div>
                </div>
            </div>
        </div>

        <div class="controls right-panel" id="right-panel">
            <button class="toggle-sidebar" id="toggle-right" title="오른쪽 패널 접기/펴기">▶</button>
            <div class="viewer-controls" id="analysis-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0;">바코드 스캐너</h3>
                    <label class="switch-container"
                        style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9em;">
                        <input type="checkbox" id="toggle-selection-mode" checked>
                        <span>활성화</span>
                    </label>
                </div>
                <div id="selection-status" class="status-text help-text" style="margin-bottom: 15px; text-align: left;">
                    드래그하여 텍스트나 QR코드를 스캔하세요</div>

                <div id="analysis-result-container" style="border-top: 1px solid #eee; padding-top: 10px;">
                    <div class="result-content" id="analysis-content">
                        <div style="color:#7f8c8d; text-align:center; padding: 20px;">분석된 결과가 여기에 표시됩니다.</div>
                    </div>
                </div>
            </div>



            <div class="viewer-controls">
                <h3>워터마크 일괄 적용</h3>
                <textarea id="watermark-text" rows="5"
                    placeholder="user1@example.com&#13;&#10;user2@example.com&#13;&#10;user3@example.com"></textarea>
                <button id="apply-watermark" , onclick="downloadWatermarkedPdf()">적용</button>
            </div>
        </div>
    </div>

    <!-- 페이지 목록 모달 -->
    <div id="page-list-modal" class="modal hidden">
        <div class="modal-content">
            <h4><span id="modal-channel-name">Cyan</span>을 사용하는 페이지</h4>
            <div id="page-list"></div>
            <button id="close-modal">닫기</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- OCR & QR Libraries -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://unpkg.com/@zxing/library@0.21.3" type="text/javascript"></script>

    <script>
        // PDF.js worker 설정
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // 워터마크 다운로드 함수
        async function downloadWatermarkedPdf() {
            const fileInput = document.getElementById('pdf-file');
            const textInput = document.getElementById('watermark-text');
            const btn = document.getElementById('apply-watermark');
            const loading = document.getElementById('loading-indicator');
            const loadingText = document.getElementById('loading-text');

            if (!fileInput.files[0]) {
                alert('먼저 PDF 파일을 열어주세요.');
                return;
            }

            const texts = textInput.value.split('\n').map(t => t.trim()).filter(t => t.length > 0);
            if (texts.length === 0) {
                alert('워터마크 텍스트를 입력해주세요.');
                return;
            }

            try {
                // UI 잠금 및 로딩 표시
                btn.disabled = true;
                loading.classList.remove('hidden');
                loadingText.textContent = '워터마크 생성 중...';

                const fileArrayBuffer = await fileInput.files[0].arrayBuffer();
                const { PDFDocument, rgb, degrees, StandardFonts } = PDFLib;

                // ZIP 생성 필요 여부 확인 (2개 이상일 때)
                if (texts.length > 1) {
                    const zip = new JSZip();

                    for (let i = 0; i < texts.length; i++) {
                        const text = texts[i];
                        loadingText.textContent = `생성 중 (${i + 1}/${texts.length}): ${text}...`;

                        // PDF 로드
                        const pdfDoc = await PDFDocument.load(fileArrayBuffer);
                        const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
                        const pages = pdfDoc.getPages();
                        const fontSize = 50;

                        pages.forEach(page => {
                            const { width, height } = page.getSize();

                            // 중앙 정렬 및 45도 회전 계산
                            const textWidth = helveticaFont.widthOfTextAtSize(text, fontSize);
                            const angle = Math.PI / 4; // 45도
                            const cos = Math.cos(angle);
                            const sin = Math.sin(angle);
                            const halfWidth = textWidth / 2;
                            const halfHeight = fontSize / 2;

                            // 화면 중앙 좌표
                            const x = width / 2 - (halfWidth * cos) + (halfHeight * sin);
                            const y = height / 2 - (halfWidth * sin) - (halfHeight * cos);

                            page.drawText(text, {
                                x: x,
                                y: y,
                                size: fontSize,
                                font: helveticaFont,
                                color: rgb(0.5, 0.5, 0.5),
                                opacity: 0.3,
                                rotate: degrees(45),
                            });
                        });

                        const pdfBytes = await pdfDoc.save();
                        zip.file(`${text}.pdf`, pdfBytes);
                    }

                    loadingText.textContent = 'ZIP 파일 생성 중...';
                    const zipContent = await zip.generateAsync({ type: 'blob' });
                    downloadBlob(zipContent, 'watermarked_files.zip');

                } else {
                    // 단일 파일 처리
                    const text = texts[0];
                    const pdfDoc = await PDFDocument.load(fileArrayBuffer);
                    const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
                    const pages = pdfDoc.getPages();
                    const fontSize = 50;

                    pages.forEach(page => {
                        const { width, height } = page.getSize();
                        const textWidth = helveticaFont.widthOfTextAtSize(text, fontSize);

                        // 중앙 정렬 및 45도 회전
                        const angle = Math.PI / 4;
                        const cos = Math.cos(angle);
                        const sin = Math.sin(angle);
                        const halfWidth = textWidth / 2;
                        const halfHeight = fontSize / 2;

                        const x = width / 2 - (halfWidth * cos) + (halfHeight * sin);
                        const y = height / 2 - (halfWidth * sin) - (halfHeight * cos);

                        page.drawText(text, {
                            x: x,
                            y: y,
                            size: fontSize,
                            font: helveticaFont,
                            color: rgb(0.5, 0.5, 0.5),
                            opacity: 0.3,
                            rotate: degrees(45),
                        });
                    });

                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/octet-stream' });
                    downloadBlob(blob, `${text}_watermarked.pdf`);
                }

            } catch (err) {
                console.error(err);
                alert('오류가 발생했습니다: ' + err.message);
            } finally {
                btn.disabled = false;
                loading.classList.add('hidden');
                loadingText.textContent = '로딩 중...'; // 복귀
            }
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 60000); // 대용량 다운로드 안정을 위해 60초 대기
        }
    </script>
    <script src="main.js" type="module"></script>
</body>

</html>